#!/usr/bin/env ruby

require 'net/http'
require 'json'
require 'uri'
require 'io/console'

class ChatGPTCLI
  API_URL = 'https://api.openai.com/v1/chat/completions'

  def initialize
    @api_key = load_api_key
    @conversation = []

    if @api_key.nil? || @api_key.empty?
      puts "Error: API key not found"
      puts "Create a file called 'openAI_api_key' with your key, or set OPENAI_API_KEY environment variable"
      exit 1
    end
  end

  def terminal_width
    IO.console&.winsize&.[](1) || 80
  end

  def wrap_text(text, width = terminal_width - 10)
    text.gsub(/(.{1,#{width}})(\s+|\Z)/, "\\1\n").strip
  end

  def load_api_key
    key_file = 'openAI_api_key'

    if File.exist?(key_file)
      File.read(key_file).strip
    else
      ENV['OPENAI_API_KEY']
    end
  end

  def start
    puts "ChatGPT CLI - Type 'exit' to quit, 'clear' to clear conversation"
    puts "-" * 60

    loop do
      print "\n> "
      input = gets.chomp

      case input.downcase
      when 'exit', 'quit'
        puts "Goodbye!"
        break
      when 'clear'
        @conversation.clear
        puts "Conversation cleared."
        next
      when ''
        next
      end

      send_message(input)
    end
  end

  private

  def send_message(message)
    @conversation << { role: "user", content: message }

    begin
      response = make_api_request

      if response['error']
        puts "API Error: #{response['error']['message']}"
        puts "Error Type: #{response['error']['type']}" if response['error']['type']
        return
      end

      if response['choices'] && response['choices'][0]
        reply = response['choices'][0]['message']['content']
        @conversation << { role: "assistant", content: reply }

        wrapped_reply = wrap_text(reply)
        puts "\nChatGPT: #{wrapped_reply}"
      else
        puts "Error: Unexpected response format"
        puts "Full response: #{response.inspect}"
      end

    rescue => e
      puts "Error: #{e.message}"
    end
  end

  def make_api_request
    uri = URI(API_URL)
    http = Net::HTTP.new(uri.host, uri.port)
    http.use_ssl = true

    request = Net::HTTP::Post.new(uri)
    request['Authorization'] = "Bearer #{@api_key}"
    request['Content-Type'] = 'application/json'

    payload = {
      model: "gpt-3.5-turbo",
      messages: @conversation,
      max_tokens: 1000,
      temperature: 0.7
    }

    request.body = payload.to_json

    response = http.request(request)
    JSON.parse(response.body)
  end
end

if __FILE__ == $0
  ChatGPTCLI.new.start
end